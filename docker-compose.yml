# Note: All services share the same Dockerfile. Docker BuildKit deduplicates builds.
services:
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DASHBOARD_FEATURES: "with-simulator"
    container_name: arvak-dashboard
    ports:
      - "3000:3000"
    environment:
      - ARVAK_BIND=0.0.0.0:3000
      - RUST_LOG=arvak=info,tower_http=debug
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  grpc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arvak-grpc
    entrypoint: ["arvak-grpc-server"]
    ports:
      - "50051:50051"
      - "9090:9090"
    environment:
      - ARVAK_GRPC_ADDRESS=0.0.0.0:50051
      - ARVAK_HTTP_ADDRESS=0.0.0.0:9090
      - RUST_LOG=arvak=info,tower_http=debug
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # One-off CLI commands:
  #   docker compose run --rm cli compile examples/bell.qasm --target simulator
  cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arvak-cli
    entrypoint: ["arvak"]
    environment:
      - RUST_LOG=info
    volumes:
      - ./examples:/home/arvak/local-examples:ro
    profiles:
      - cli

  # Run demos:
  #   docker compose run --rm demo demo-grover
  #   docker compose run --rm demo demo-vqe
  #   docker compose run --rm demo demo-qaoa
  #   docker compose run --rm demo demo-all
  #   docker compose run --rm demo lumi_vqe --mode local
  demo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arvak-demo
    entrypoint: []
    environment:
      - RUST_LOG=info
    profiles:
      - demo
